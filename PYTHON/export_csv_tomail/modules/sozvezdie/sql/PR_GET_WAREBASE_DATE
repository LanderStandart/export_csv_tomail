SET TERM ^ ;

create or alter procedure PR_GET_WAREBASE_FROM_DATE (
    DATE_W DM_DATETIME,
    PARTID DM_ID,
    PROFILE DM_ID)
returns (
    QUANT DM_DOUBLE)
as
begin
select
coalesce((select iif(w.quant<0,0,w.quant)
            from warebase_d w
          where w.part_id=:partid and w.g$profile_id=:PROFILE
          and w.doc_commitdate= '01.'||extract(month from :date_w)||'.'||extract (year from :date_w)),0)+iif(quant<0,0,quant)
from
 ( Select
     -- dd.part_id,
  cast(coalesce(sum(dd.quant),0)as numeric (9,2))as quant
  from
   doc_detail dd
 -- left join docs d on d.id=dd.doc_id
 --    inner join docs d on dd.doc_id=d.id and d.status=1 and d.docdate   between '01.01.'||extract (year from current_date) and :DATE_W
  where
    dd.doc_commitdate between '01.'||extract(month from :date_w)||'.'||extract (year from :date_w) and :DATE_W and
    --dd.doc_commitdate <=:date_w and
    dd.part_id =:partid and dd.g$profile_id=:PROFILE) q
  into :quant;
--  do
  suspend;
end^

SET TERM ; ^

/* Following GRANT statetements are generated automatically */

GRANT SELECT ON WAREBASE_D TO PROCEDURE PR_GET_WAREBASE_FROM_DATE;
GRANT SELECT ON DOC_DETAIL TO PROCEDURE PR_GET_WAREBASE_FROM_DATE;

/* Existing privileges on this procedure */

GRANT EXECUTE ON PROCEDURE PR_GET_WAREBASE_FROM_DATE TO PROCEDURE PR_SOZVEZDIE_ACTION_REMHANT;
GRANT EXECUTE ON PROCEDURE PR_GET_WAREBASE_FROM_DATE TO SYSDBA;